<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "Omni Chat" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
              950: '#172554'
            }
          }
        }
      }
    }
  </script>
  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    /* Ensure native dropdown popups are readable */
    select { color: #e5e7eb; background-color: rgba(255,255,255,0.08); }
    select:focus { outline: none; }
    select option { color: #0f172a; background-color: #ffffff; }
    
    /* Typing indicator animation */
    [id^="typing-indicator-"] {
      animation: blink 1s infinite;
      color: #60a5fa;
    }
    
    /* Loading indicator animation */
    [id^="loading-indicator-"] {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    /* Tab styling */
    .tab-button {
      color: rgba(255, 255, 255, 0.6);
    }
    .tab-button.active {
      background-color: rgba(59, 130, 246, 0.2);
      color: rgb(147, 197, 253);
    }
    .tab-button:hover {
      color: rgba(255, 255, 255, 0.8);
    }
    
    /* Navigation tab styling */
    .nav-tab {
      color: rgba(255, 255, 255, 0.6);
    }
    .nav-tab.active {
      background-color: rgba(59, 130, 246, 0.2);
      color: rgb(147, 197, 253);
    }
    .nav-tab:hover {
      color: rgba(255, 255, 255, 0.8);
      background-color: rgba(255, 255, 255, 0.05);
    }
  </style>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body class="h-svh min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white antialiased">
  <main class="relative h-full w-full flex flex-col">
    <div class="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-white/10 to-transparent"></div>
    
    <!-- Navigation -->
    <nav class="flex items-center justify-between px-4 md:px-6 py-3 border-b border-white/10 flex-shrink-0">
      <div class="flex items-center space-x-6">
        <div class="text-xl font-semibold tracking-tight">Omni Chat</div>
        <div class="flex space-x-1">
          <a href="/" id="nav-chat" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium transition-all">
            <span class="material-icons text-base align-text-bottom mr-1">chat</span>Chat
          </a>
          <a href="/schedule" id="nav-schedule" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium transition-all">
            <span class="material-icons text-base align-text-bottom mr-1">schedule</span>Schedule
          </a>
        </div>
      </div>
      <button id="settings-btn" class="text-white/80 hover:text-white text-xl" title="Settings">
        <span class="material-icons">settings</span>
      </button>
    </nav>

    <!-- Main content area that takes remaining height -->
    <section class="flex flex-col flex-1 min-h-0 w-full px-4 md:px-6 py-4">
      {% if request.endpoint != 'home' %}
      <header class="mb-3 md:mb-4 flex items-center justify-between flex-shrink-0">
        <div class="text-2xl md:text-3xl font-semibold tracking-tight">
          {% block header %}{% endblock %}
        </div>
        {% block header_actions %}{% endblock %}
      </header>
      {% endif %}
      
      <div class="flex-1 min-h-0 text-white/90">
        {% block content %}{% endblock %}
      </div>
      {% block extra %}{% endblock %}
    </section>
  </main>
  
  <!-- Include task modal if on schedule page -->
  {% if request.endpoint == 'schedule' %}
    {% include 'fragments/task-modal.html' %}
  {% endif %}

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="relative mx-auto mt-16 w-11/12 max-w-lg rounded-xl border border-white/10 bg-slate-900">
      <div class="flex items-center justify-between p-4 pb-0">
        <h2 class="text-lg font-semibold">Settings</h2>
        <button class="text-white/70 hover:text-white" data-close>
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="px-4 pt-3">
        <div class="flex space-x-1 bg-white/5 rounded-lg p-1">
          <button id="tab-keys" class="tab-button flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all active">
            <span class="material-icons text-base align-text-bottom mr-1">vpn_key</span>API Keys
          </button>
          <button id="tab-email" class="tab-button flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all">
            <span class="material-icons text-base align-text-bottom mr-1">email</span>Email
          </button>
          <button id="tab-blacklist" class="tab-button flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all">
            <span class="material-icons text-base align-text-bottom mr-1">block</span>Blacklist
          </button>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="p-4">
        <!-- API Keys Tab -->
        <div id="content-keys" class="tab-content">
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-white/70 mb-1">OpenAI API Key</label>
              <input id="key-openai" type="password" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="sk-..." />
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-1">Gemini API Key</label>
              <input id="key-gemini" type="password" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="..." />
            </div>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="space-x-2">
              <button id="delete-openai" class="rounded-lg bg-red-600 hover:bg-red-500 px-3 py-2 text-sm">Delete OpenAI</button>
              <button id="delete-gemini" class="rounded-lg bg-red-600 hover:bg-red-500 px-3 py-2 text-sm">Delete Gemini</button>
            </div>
            <div class="space-x-2">
              <button id="save-keys" class="rounded-lg bg-primary-600 hover:bg-primary-500 px-4 py-2 text-sm">Save</button>
            </div>
          </div>
        </div>

        <!-- Email Configuration Tab -->
        <div id="content-email" class="tab-content hidden">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-white/70 mb-1">SMTP Server</label>
                <input id="email-smtp-server" type="text" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="smtp.gmail.com" />
              </div>
              <div>
                <label class="block text-sm text-white/70 mb-1">Port</label>
                <input id="email-smtp-port" type="number" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="587" />
              </div>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-1">From Email Address</label>
              <input id="email-from" type="email" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="your-email@gmail.com" />
              <p class="text-xs text-white/50 mt-1">The email address that appears as sender</p>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-1">SMTP Username</label>
              <input id="email-username" type="text" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="your-email@gmail.com" />
              <p class="text-xs text-white/50 mt-1">Usually the same as your email address</p>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-1">Password / App Password</label>
              <input id="email-password" type="password" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="your-app-password" />
            </div>
            <div class="flex items-center space-x-2">
              <input id="email-use-tls" type="checkbox" class="rounded bg-white/10 border border-white/10" checked />
              <label for="email-use-tls" class="text-sm text-white/70">Use TLS encryption</label>
            </div>
            <div class="bg-blue-500/10 border border-blue-400/20 rounded-lg p-3">
              <h4 class="text-sm font-medium text-blue-300 mb-1">Test Email Configuration</h4>
              <p class="text-xs text-blue-200/80 mb-2">Send a test email to verify your settings</p>
              <div class="flex space-x-2">
                <input id="test-email-address" type="email" class="flex-1 rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="test-recipient@example.com" />
                <button id="test-email" class="rounded-lg bg-blue-600 hover:bg-blue-500 px-4 py-2 text-sm">Test</button>
              </div>
              <div id="email-test-result" class="mt-2 text-xs hidden"></div>
            </div>
          </div>
          <div class="mt-4 flex justify-end space-x-2">
            <button id="save-email" class="rounded-lg bg-primary-600 hover:bg-primary-500 px-4 py-2 text-sm">Save Configuration</button>
          </div>
        </div>

        <!-- Blacklist Tab -->
        <div id="content-blacklist" class="tab-content hidden">
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-white/70 mb-1">Add Blacklisted Words</label>
              <p class="text-xs text-white/50 mb-2">Enter words that should trigger a warning before sending messages</p>
              <div class="flex space-x-2">
                <input id="blacklist-input" type="text" class="flex-1 rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm" placeholder="Enter a word..." />
                <button id="add-blacklist" class="rounded-lg bg-primary-600 hover:bg-primary-500 px-4 py-2 text-sm">Add</button>
              </div>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-2">Current Blacklist</label>
              <div id="blacklist-words" class="space-y-1 max-h-32 overflow-y-auto">
                <p class="text-xs text-white/50">No blacklisted words</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 pt-4 border-t border-white/10 text-right">
          <button class="rounded-lg bg-white/10 hover:bg-white/20 px-4 py-2 text-sm" data-close>Close</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  // Navigation functionality
  function setActiveNavTab() {
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    if (currentPath === '/schedule') {
      document.getElementById('nav-schedule').classList.add('active');
    } else {
      document.getElementById('nav-chat').classList.add('active');
    }
  }
  
  // Initialize navigation on page load
  setActiveNavTab();
  
  // Settings Modal functionality
  const settingsBtn = document.getElementById('settings-btn');
  const modal = document.getElementById('settings-modal');
  const openaiInput = document.getElementById('key-openai');
  const geminiInput = document.getElementById('key-gemini');
  const saveBtn = document.getElementById('save-keys');
  const delOpenai = document.getElementById('delete-openai');
  const delGemini = document.getElementById('delete-gemini');
  
  // Tab elements
  const tabKeys = document.getElementById('tab-keys');
  const tabEmail = document.getElementById('tab-email');
  const tabBlacklist = document.getElementById('tab-blacklist');
  const contentKeys = document.getElementById('content-keys');
  const contentEmail = document.getElementById('content-email');
  const contentBlacklist = document.getElementById('content-blacklist');
  
  // Email elements
  const emailSmtpServer = document.getElementById('email-smtp-server');
  const emailSmtpPort = document.getElementById('email-smtp-port');
  const emailFrom = document.getElementById('email-from');
  const emailUsername = document.getElementById('email-username');
  const emailPassword = document.getElementById('email-password');
  const emailUseTls = document.getElementById('email-use-tls');
  const saveEmailBtn = document.getElementById('save-email');
  const testEmailBtn = document.getElementById('test-email');
  const testEmailAddress = document.getElementById('test-email-address');
  const emailTestResult = document.getElementById('email-test-result');
  
  // Blacklist elements
  const blacklistInput = document.getElementById('blacklist-input');
  const addBlacklistBtn = document.getElementById('add-blacklist');
  const blacklistWords = document.getElementById('blacklist-words');

  // Tab switching
  function switchToTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    
    if (tab === 'keys') {
      tabKeys.classList.add('active');
      contentKeys.classList.remove('hidden');
    } else if (tab === 'email') {
      tabEmail.classList.add('active');
      contentEmail.classList.remove('hidden');
    } else if (tab === 'blacklist') {
      tabBlacklist.classList.add('active');
      contentBlacklist.classList.remove('hidden');
    }
  }

  tabKeys.addEventListener('click', () => switchToTab('keys'));
  tabEmail.addEventListener('click', () => switchToTab('email'));
  tabBlacklist.addEventListener('click', () => switchToTab('blacklist'));

  async function loadKeys() {
    try {
      const r = await fetch('/api/keys');
      if (!r.ok) return;
      const data = await r.json();
      openaiInput.value = data.openai || '';
      geminiInput.value = data.gemini || '';
    } catch (_) {}
  }

  async function loadBlacklist() {
    try {
      const r = await fetch('/api/blacklist');
      if (!r.ok) return;
      const data = await r.json();
      renderBlacklist(data.blacklist || []);
    } catch (_) {}
  }

  async function loadEmailConfig() {
    try {
      const r = await fetch('/api/email/config');
      if (!r.ok) return;
      const data = await r.json();
      emailSmtpServer.value = data.smtp_server || '';
      emailSmtpPort.value = data.smtp_port || '587';
      emailFrom.value = data.from_email || '';
      emailUsername.value = data.smtp_username || '';
      emailPassword.value = data.smtp_password === '***' ? '' : (data.smtp_password || '');
      emailUseTls.checked = data.smtp_use_tls !== 'false';
    } catch (_) {}
  }

  async function saveEmailConfig() {
    const config = {
      smtp_server: emailSmtpServer.value.trim(),
      smtp_port: emailSmtpPort.value.trim(),
      from_email: emailFrom.value.trim(),
      smtp_username: emailUsername.value.trim(),
      smtp_password: emailPassword.value.trim(),
      smtp_use_tls: emailUseTls.checked ? 'true' : 'false'
    };

    try {
      const r = await fetch('/api/email/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });

      if (r.ok) {
        showEmailResult('Email configuration saved successfully!', 'success');
      } else {
        const error = await r.json();
        showEmailResult(`Error: ${error.error}`, 'error');
      }
    } catch (err) {
      showEmailResult(`Error: ${err.message}`, 'error');
    }
  }

  async function testEmailConfig() {
    const testEmail = testEmailAddress.value.trim();
    if (!testEmail) {
      showEmailResult('Please enter a test email address', 'error');
      return;
    }

    testEmailBtn.textContent = 'Sending...';
    testEmailBtn.disabled = true;

    try {
      const r = await fetch('/api/email/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to_email: testEmail })
      });

      if (r.ok) {
        const data = await r.json();
        showEmailResult(`Test email sent successfully to ${testEmail}!`, 'success');
      } else {
        const error = await r.json();
        showEmailResult(`Test failed: ${error.error}`, 'error');
      }
    } catch (err) {
      showEmailResult(`Test failed: ${err.message}`, 'error');
    } finally {
      testEmailBtn.textContent = 'Test';
      testEmailBtn.disabled = false;
    }
  }

  function showEmailResult(message, type) {
    emailTestResult.textContent = message;
    emailTestResult.className = `mt-2 text-xs ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
    emailTestResult.classList.remove('hidden');
    setTimeout(() => {
      emailTestResult.classList.add('hidden');
    }, 5000);
  }

  function renderBlacklist(words) {
    if (words.length === 0) {
      blacklistWords.innerHTML = '<p class="text-xs text-white/50">No blacklisted words</p>';
      return;
    }
    
    blacklistWords.innerHTML = words.map(word => `
      <div class="flex items-center justify-between bg-white/5 rounded px-2 py-1">
        <span class="text-sm">${escapeHtml(word)}</span>
        <button class="text-red-400 hover:text-red-300 text-xs" onclick="removeBlacklistWord('${escapeHtml(word)}')">Remove</button>
      </div>
    `).join('');
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  async function addBlacklistWord() {
    const word = blacklistInput.value.trim();
    if (!word) return;
    
    try {
      // Use the universal blacklist API if available, otherwise fallback to direct fetch
      if (window.blacklistAPI) {
        const data = await window.blacklistAPI.add(word);
        if (data) {
          renderBlacklist(data.blacklist);
          blacklistInput.value = '';
        }
      } else {
        const r = await fetch('/api/blacklist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word })
        });
        if (r.ok) {
          const data = await r.json();
          renderBlacklist(data.blacklist);
          blacklistInput.value = '';
          // Check if blacklist was updated and refresh cache
          if (r.headers.get('X-Blacklist-Updated') === 'true') {
            // Refresh the blacklist cache in the main page
            if (window.loadBlacklist) {
              window.loadBlacklist();
            }
            // Trigger global blacklist update event
            if (window.dispatchEvent) {
              window.dispatchEvent(new CustomEvent('blacklistUpdated', { detail: data.blacklist }));
            }
          }
        }
      }
    } catch (_) {}
  }

  async function removeBlacklistWord(word) {
    try {
      // Use the universal blacklist API if available, otherwise fallback to direct fetch
      if (window.blacklistAPI) {
        const data = await window.blacklistAPI.remove(word);
        if (data) {
          renderBlacklist(data.blacklist);
        }
      } else {
        const r = await fetch(`/api/blacklist?word=${encodeURIComponent(word)}`, {
          method: 'DELETE'
        });
        if (r.ok) {
          const data = await r.json();
          renderBlacklist(data.blacklist);
          // Check if blacklist was updated and refresh cache
          if (r.headers.get('X-Blacklist-Updated') === 'true') {
            // Refresh the blacklist cache in the main page
            if (window.loadBlacklist) {
              window.loadBlacklist();
            }
            // Trigger global blacklist update event
            if (window.dispatchEvent) {
              window.dispatchEvent(new CustomEvent('blacklistUpdated', { detail: data.blacklist }));
            }
          }
        }
      }
    } catch (_) {}
  }

  // Make removeBlacklistWord available globally for onclick handlers
  window.removeBlacklistWord = removeBlacklistWord;

  function openModal() {
    modal.classList.remove('hidden');
    loadKeys();
    loadEmailConfig();
    loadBlacklist();
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  settingsBtn?.addEventListener('click', openModal);
  modal?.querySelectorAll('[data-close]')?.forEach(btn => btn.addEventListener('click', closeModal));

  saveBtn?.addEventListener('click', async () => {
    const body = { openai: openaiInput.value.trim(), gemini: geminiInput.value.trim() };
    try {
      await fetch('/api/keys', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      closeModal();
      loadKeys();
    } catch (_) {}
  });
  
  delOpenai?.addEventListener('click', async () => {
    try { await fetch('/api/keys/openai', { method: 'DELETE' }); openaiInput.value=''; loadKeys(); } catch (_) {}
  });
  
  delGemini?.addEventListener('click', async () => {
    try { await fetch('/api/keys/gemini', { method: 'DELETE' }); geminiInput.value=''; loadKeys(); } catch (_) {}
  });

  // Email functionality
  saveEmailBtn?.addEventListener('click', saveEmailConfig);
  testEmailBtn?.addEventListener('click', testEmailConfig);

  // Blacklist functionality
  addBlacklistBtn?.addEventListener('click', addBlacklistWord);
  blacklistInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBlacklistWord();
    }
  });
  </script>
</body>
</html>
