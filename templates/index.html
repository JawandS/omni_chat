{% extends "base.html" %}

{% block header %}
Omni Chat
{% endblock %}

{% block content %}
<div class="grid grid-cols-12 gap-4 md:gap-6 h-full min-h-0">
  <!-- Sidebar: conversation history and projects -->
  <aside class="hidden md:block col-span-3 min-h-0">
    <div class="h-full min-h-0 rounded-xl border border-white/10 bg-white/5 flex flex-col">
      <!-- Tab headers -->
      <div class="p-3 border-b border-white/10">
        <div class="flex">
          <button id="tab-chats" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-white/10 text-white">Chats</button>
          <button id="tab-projects" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg text-white/70 hover:text-white hover:bg-white/5 transition ml-1">Projects</button>
        </div>
      </div>
      
      <!-- Chats tab content -->
      <div id="chats-tab" class="flex-1 min-h-0 flex flex-col">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <span class="font-medium">History</span>
          <button id="clear-history" class="text-sm text-white/70 hover:text-white">Clear</button>
        </div>
        <div id="history" class="flex-1 p-3 space-y-2 overflow-auto"></div>
      </div>
      
      <!-- Projects tab content -->
      <div id="projects-tab" class="flex-1 min-h-0 flex-col hidden">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <span class="font-medium">Projects</span>
          <button id="new-project" class="text-sm text-white/70 hover:text-white">New</button>
        </div>
        <div id="projects-list" class="flex-1 p-3 space-y-2 overflow-auto"></div>
      </div>
    </div>
  </aside>

  <!-- Main chat area -->
  <section class="col-span-12 md:col-span-9 flex flex-col min-h-0">
    <!-- Top bar: provider + model selectors + centered title -->
    <div class="rounded-xl border border-white/10 bg-white/5 p-3 md:p-4 mb-3 md:mb-4">
      <div class="flex items-center gap-3">
        <!-- Favorites dropdown -->
        <div class="flex items-center gap-2">
          <div class="relative w-24"> <!-- fixed width to prevent expansion -->
            <select id="favorite-model" class="w-full appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-6 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition truncate" aria-label="Favorite model quick select">
              <option value="" disabled selected>Favorites</option>
            </select>
            <span class="pointer-events-none absolute right-1.5 top-1/2 -translate-y-1/2 text-white/70">â–¾</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="provider" class="text-sm text-white/70">Provider</label>
          <div class="relative">
            <select id="provider" data-testid="provider-select" class="appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition">
              <option>Loadingâ€¦</option>
            </select>
            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/70">â–¾</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="model" class="text-sm text-white/70">Model</label>
          <div class="relative">
            <div class="relative">
              <select id="model" data-testid="model-select" class="appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-28 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition min-w-48">
                <option>Select provider first</option>
              </select>
              <span class="pointer-events-none absolute right-20 top-1/2 -translate-y-1/2 text-white/70" style="right:4.75rem">â–¾</span>
              <button id="toggle-favorite" title="Toggle favorite" class="absolute right-12 top-1/2 -translate-y-1/2 text-white/40 hover:text-yellow-400 transition" aria-label="Toggle favorite">â˜†</button>
              <button id="model-config-btn" title="Configure model parameters" class="absolute right-1 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 text-white/70 hover:text-white transition" aria-label="Configure model">
                <!-- Gear icon (SVG) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.757.426 1.757 2.924 0 3.35a1.724 1.724 0 0 0-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0-2.572 1.065c-.426 1.757-2.924 1.757-3.35 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0-1.065-2.572c-1.757-.426-1.757-2.924 0-3.35a1.724 1.724 0 0 0 1.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.607 2.296.07 2.573-1.065Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="project" class="text-sm text-white/70">Project</label>
          <div class="relative">
            <select id="project" class="appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition">
              <option value="">No project</option>
            </select>
            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/70">â–¾</span>
          </div>
        </div>
        <!-- Centered title -->
        <div class="flex-1 flex justify-center">
          <input id="chat-title" type="text" placeholder="Untitled chat" class="w-56 md:w-80 text-center rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 placeholder-white/40" />
        </div>
        <div class="ms-auto flex items-center gap-2">
          <button id="new-chat" class="inline-flex items-center rounded-lg bg-primary-600 hover:bg-primary-500 focus:ring-4 focus:ring-primary-400/40 px-4 py-2 text-sm font-medium transition">New Chat</button>
          <button id="delete-chat" class="inline-flex items-center rounded-lg bg-red-600 hover:bg-red-500 focus:ring-4 focus:ring-red-400/40 px-3 py-2 text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" title="Delete current chat">Delete</button>
        </div>
      </div>
    </div>

  <!-- Warning toast -->
  <div id="toast" class="hidden mb-2 rounded-lg bg-yellow-500/20 border border-yellow-400/30 text-yellow-200 text-sm px-3 py-2"></div>
  <!-- Messages -->
  <div id="messages" class="flex-1 min-h-0 overflow-y-auto space-y-4 pr-1">
      <div class="flex items-start gap-3">
        <div class="shrink-0 w-8 h-8 rounded-full bg-primary-600/80 grid place-items-center">ðŸ§ </div>
        <div class="rounded-xl border border-white/10 bg-white/5 p-3 max-w-3xl">
          <p class="text-white/90">Hi! Ask me anything. Iâ€™ll respond here.</p>
        </div>
      </div>
    </div>

    <!-- Composer -->
  <form id="composer" class="mt-3 md:mt-4">
      <div class="relative">
    <textarea id="input" rows="1" placeholder="Messageâ€¦" class="w-full resize-none rounded-2xl border border-white/10 bg-white/5 focus:bg-white/10 transition p-4 pr-24 outline-none focus:ring-2 focus:ring-primary-400/40"></textarea>
    <button id="send" type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center rounded-xl bg-primary-600 hover:bg-primary-500 focus:ring-4 focus:ring-primary-400/40 px-3 py-2 text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
      </div>
      <p class="mt-2 text-xs text-white/50">Press Enter to send â€¢ Shift+Enter for newline</p>
    </form>
  </section>
</div>

<!-- Centered modal for model configuration -->
<div id="config-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity z-40 flex items-center justify-center p-4">
  <div id="config-modal" class="w-full max-w-xl bg-neutral-900 border border-white/15 rounded-2xl shadow-2xl ring-1 ring-black/60 flex flex-col max-h-[85vh] opacity-0 scale-95 transition-all">
    <div class="px-5 py-4 border-b border-white/10 flex items-center gap-3">
      <div class="flex items-center gap-2 text-sm font-semibold tracking-wide">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-primary-600/20 text-primary-300">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.757.426 1.757 2.924 0 3.35a1.724 1.724 0 0 0-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0-2.572 1.065c-.426 1.757-2.924 1.757-3.35 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0-1.065-2.572c-1.757-.426-1.757-2.924 0-3.35a1.724 1.724 0 0 0 1.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.607 2.296.07 2.573-1.065Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
        </span>
        <span>Model Parameters</span>
      </div>
      <div class="ms-auto flex items-center gap-2">
        <button id="reset-config" class="text-xs text-white/50 hover:text-white underline decoration-dotted">Reset</button>
        <button id="close-config" class="w-8 h-8 inline-flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition" title="Close" aria-label="Close">
          âœ•
        </button>
      </div>
    </div>
    <div id="config-body" class="p-5 overflow-y-auto text-sm space-y-5 flex-1">
      <p class="text-white/50">Select a provider & model to load configurable parameters.</p>
    </div>
    <div class="px-5 py-4 border-t border-white/10 flex justify-end gap-3">
      <button id="close-config-footer" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white/80 hover:text-white transition">Close</button>
      <button id="apply-config" class="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-500 focus:ring-2 focus:ring-primary-400/40 text-sm font-medium transition">Apply</button>
    </div>
  </div>
</div>

<!-- Project Management Modal -->
<div id="project-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity z-40 flex items-center justify-center p-4">
  <div id="project-modal" class="w-full max-w-4xl bg-neutral-900 border border-white/15 rounded-2xl shadow-2xl ring-1 ring-black/60 flex flex-col max-h-[90vh] opacity-0 scale-95 transition-all">
    <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
      <div class="flex items-center gap-2 text-sm font-semibold tracking-wide">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-primary-600/20 text-primary-300">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25H11.69l-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v6.75Z"/></svg>
        </span>
        <span id="project-modal-title">Project Management</span>
      </div>
      <button id="close-project" class="text-white/60 hover:text-white transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="flex flex-1 min-h-0">
      <!-- Project list panel -->
      <div class="w-64 border-r border-white/10 flex flex-col">
        <div class="p-4 border-b border-white/10">
          <button id="new-project-btn" class="w-full px-3 py-2 rounded-lg bg-primary-600 hover:bg-primary-500 text-sm text-white transition">
            New Project
          </button>
        </div>
        <div id="project-list-panel" class="flex-1 p-3 space-y-2 overflow-auto"></div>
      </div>
      
      <!-- Project details panel -->
      <div class="flex-1 flex flex-col min-h-0">
        <div id="project-details" class="flex-1 p-5 overflow-auto">
          <div id="no-project-selected" class="flex items-center justify-center h-full text-white/50">
            Select a project to view details
          </div>
          
          <div id="project-form" class="hidden space-y-4">
            <div>
              <label for="project-name" class="block text-sm font-medium text-white mb-2">Name</label>
              <input id="project-name" type="text" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40" placeholder="Project name">
            </div>
            
            <div>
              <label for="project-description" class="block text-sm font-medium text-white mb-2">Description</label>
              <textarea id="project-description" rows="3" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 resize-none" placeholder="Project description"></textarea>
            </div>
            
            <div>
              <label for="project-system-prompt" class="block text-sm font-medium text-white mb-2">System Prompt</label>
              <textarea id="project-system-prompt" rows="4" class="w-full rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 resize-none" placeholder="System prompt for this project..."></textarea>
            </div>
            
            <div class="flex gap-2">
              <button id="save-project" class="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-500 text-sm text-white transition">Save</button>
              <button id="delete-project" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-sm text-white transition">Delete</button>
            </div>
            
            <hr class="border-white/10">
            
            <!-- Project files section -->
            <div>
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-medium text-white">Files</h3>
                <button id="new-file-btn" class="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white transition">Add File</button>
              </div>
              <div id="project-files" class="space-y-2"></div>
            </div>
          </div>
        </div>
        
        <div class="px-5 py-4 border-t border-white/10 flex justify-end">
          <button id="close-project-footer" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm text-white/80 hover:text-white transition">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const providerEl = document.getElementById('provider');
  const favoriteModelEl = document.getElementById('favorite-model');
  const modelEl = document.getElementById('model');
  const toggleFavoriteBtn = document.getElementById('toggle-favorite');
  const messagesEl = document.getElementById('messages');
  const composerEl = document.getElementById('composer');
  const inputEl = document.getElementById('input');
  const newChatEl = document.getElementById('new-chat');
  const historyEl = document.getElementById('history');
  const clearHistoryEl = document.getElementById('clear-history');
  const chatTitleEl = document.getElementById('chat-title');
  const deleteChatEl = document.getElementById('delete-chat');
  const toastEl = document.getElementById('toast');
  const modelConfigBtn = document.getElementById('model-config-btn');
  const configOverlay = document.getElementById('config-overlay');
  const configModal = document.getElementById('config-modal');
  const closeConfigBtn = document.getElementById('close-config');
  const closeConfigFooterBtn = document.getElementById('close-config-footer');
  const applyConfigBtn = document.getElementById('apply-config');
  const configBody = document.getElementById('config-body');
  const resetConfigBtn = document.getElementById('reset-config');

  // Project management elements
  const projectEl = document.getElementById('project');
  const tabChatsEl = document.getElementById('tab-chats');
  const tabProjectsEl = document.getElementById('tab-projects');
  const chatsTabEl = document.getElementById('chats-tab');
  const projectsTabEl = document.getElementById('projects-tab');
  const projectsListEl = document.getElementById('projects-list');
  const newProjectSidebarEl = document.getElementById('new-project');
  const projectOverlay = document.getElementById('project-overlay');
  const projectModal = document.getElementById('project-modal');
  const closeProjectBtn = document.getElementById('close-project');
  const closeProjectFooterBtn = document.getElementById('close-project-footer');
  const newProjectBtn = document.getElementById('new-project-btn');
  const projectListPanel = document.getElementById('project-list-panel');
  const projectForm = document.getElementById('project-form');
  const noProjectSelected = document.getElementById('no-project-selected');
  const projectNameEl = document.getElementById('project-name');
  const projectDescriptionEl = document.getElementById('project-description');
  const projectSystemPromptEl = document.getElementById('project-system-prompt');
  const saveProjectBtn = document.getElementById('save-project');
  const deleteProjectBtn = document.getElementById('delete-project');
  const newFileBtnEl = document.getElementById('new-file-btn');
  const projectFilesEl = document.getElementById('project-files');

  // In-memory current param values keyed by name
  let currentParams = {};
  let defaultParams = {};
  function showToast(msg) {
    if (!msg) return;
    toastEl.textContent = msg;
    toastEl.classList.remove('hidden');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.add('hidden'), 4000);
  }

  let providers = [];
  let favorites = [];
  let defaultSelection = { provider: null, model: null };
  let history = [];
  let currentChatId = null;
  let isSubmitting = false; // Flag to prevent duplicate submissions

  // Project management state
  let projects = [];
  let currentProjectId = null;
  let selectedProjectIdInModal = null;

  async function loadProviders() {
    try {
      const res = await fetch('/api/providers-config', { cache: 'no-store' });
      const data = await res.json();
      providers = data.providers || [];
      favorites = data.favorites || [];
      defaultSelection = data.default || { provider: null, model: null };
      providerEl.innerHTML = providers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      if (defaultSelection.provider && providers.some(p => p.id === defaultSelection.provider)) {
        providerEl.value = defaultSelection.provider;
      } else if (providers.length) {
        providerEl.value = providers[0].id;
      }
      populateModels();
      populateFavoritesDropdown();
    } catch (e) {
      // Fallback
      providers = [{ id: 'openai', name: 'OpenAI', models: ['gpt-4o-mini'] }];
      providerEl.innerHTML = `<option value="openai">OpenAI</option>`;
      populateModels();
    }
  }

  function populateModels() {
    const p = providers.find(x => x.id === providerEl.value);
    const models = p ? p.models : [];
    modelEl.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('') || '<option>No models</option>';
    // If default model matches current provider select it
    if (defaultSelection.provider === providerEl.value && defaultSelection.model && models.includes(defaultSelection.model)) {
      modelEl.value = defaultSelection.model;
    }
    updateFavoriteStar();
  // Reload model parameter schema when model changes
  fetchModelConfig();
  }
  function populateFavoritesDropdown() {
    const options = ['<option value="" disabled>Favorites</option>'];
    for (const fav of favorites) {
      // Split only on first colon to handle model names with colons (like ollama:model:tag)
      const colonIndex = fav.indexOf(':');
      if (colonIndex !== -1) {
        const prov = fav.substring(0, colonIndex);
        const model = fav.substring(colonIndex + 1);
        options.push(`<option value="${fav}">${prov}:${model}</option>`);
      }
    }
    favoriteModelEl.innerHTML = options.join('');
    // Always ensure placeholder is selected after repopulation
    favoriteModelEl.selectedIndex = 0;
  }

  favoriteModelEl.addEventListener('change', () => {
    const val = favoriteModelEl.value;
    if (!val) return;
    
    // Split only on the first colon to handle model names with colons (like ollama:model:tag)
    const colonIndex = val.indexOf(':');
    if (colonIndex === -1) return;
    
    const prov = val.substring(0, colonIndex);
    const model = val.substring(colonIndex + 1);
    
    if (prov && model) {
      providerEl.value = prov;
      populateModels();
      
      // Check if the model is available in the models list before setting it
      const modelOptions = Array.from(modelEl.options).map(opt => opt.value);
      if (modelOptions.includes(model)) {
        modelEl.value = model;
      } else {
        console.warn(`Model "${model}" not found in provider "${prov}" models:`, modelOptions);
      }
      
      updateFavoriteStar();
      // Reset dropdown back to placeholder so selection doesn't persist visually
      favoriteModelEl.selectedIndex = 0;
    }
  });

  function updateFavoriteStar() {
    const key = `${providerEl.value}:${modelEl.value}`;
    if (favorites.includes(key)) {
      toggleFavoriteBtn.textContent = 'â˜…';
      toggleFavoriteBtn.classList.add('text-yellow-400');
    } else {
      toggleFavoriteBtn.textContent = 'â˜†';
      toggleFavoriteBtn.classList.remove('text-yellow-400');
    }
  }

  toggleFavoriteBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const provider = providerEl.value;
    const model = modelEl.value;
    const key = `${provider}:${model}`;
    try {
      if (favorites.includes(key)) {
        await fetch(`/api/favorites?provider=${encodeURIComponent(provider)}&model=${encodeURIComponent(model)}`, { method: 'DELETE' });
        favorites = favorites.filter(f => f !== key);
      } else {
        await fetch('/api/favorites', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ provider, model }) });
        favorites.push(key);
      }
      populateFavoritesDropdown();
      updateFavoriteStar();
    } catch (err) {
      showToast('Favorite update failed');
    }
  });

  modelEl.addEventListener('change', () => {
    updateFavoriteStar();
  fetchModelConfig();
  });

  providerEl.addEventListener('change', () => {
    populateModels();
  fetchModelConfig();
  });
  function openConfigModal() {
    configOverlay.classList.remove('pointer-events-none');
    requestAnimationFrame(() => {
      configOverlay.classList.add('opacity-100');
      configModal.classList.add('opacity-100','scale-100');
    });
    fetchModelConfig();
  }
  function closeConfigModal() {
    configOverlay.classList.add('pointer-events-none');
    configOverlay.classList.remove('opacity-100');
    configModal.classList.remove('opacity-100','scale-100');
  }
  modelConfigBtn.addEventListener('click', (e) => { e.preventDefault(); openConfigModal(); });
  closeConfigBtn.addEventListener('click', () => closeConfigModal());
  closeConfigFooterBtn.addEventListener('click', () => closeConfigModal());
  applyConfigBtn.addEventListener('click', () => closeConfigModal());
  configOverlay.addEventListener('click', (e) => { if (e.target === configOverlay) closeConfigModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeConfigModal(); });
  resetConfigBtn.addEventListener('click', (e) => { e.preventDefault(); currentParams = { ...defaultParams }; renderParamsForm(); });

  async function fetchModelConfig() {
    const provider = providerEl.value;
    const model = modelEl.value;
    if (!provider || !model) return;
    try {
      const res = await fetch(`/api/model-config?provider=${encodeURIComponent(provider)}&model=${encodeURIComponent(model)}`);
      if (!res.ok) throw new Error('config fetch failed');
      const data = await res.json();
      const params = data.params || [];
      defaultParams = {};
      params.forEach(p => { defaultParams[p.name] = p.default; });
      // Preserve any existing values for parameters when switching models within same provider if names overlap
      currentParams = Object.fromEntries(Object.entries(defaultParams).map(([k,v]) => [k, (k in currentParams) ? currentParams[k] : v]));
      renderParamsForm(params);
    } catch (e) {
      configBody.innerHTML = '<p class="text-red-300 text-sm">Failed to load model configuration.</p>';
    }
  }

  function renderParamsForm(paramsMeta) {
    paramsMeta = paramsMeta || [];
    if (!paramsMeta.length) {
      configBody.innerHTML = '<p class="text-white/50 text-sm">No configurable parameters for this model.</p>';
      return;
    }
    const fields = paramsMeta.map(meta => {
      const val = currentParams[meta.name];
      if (meta.type === 'number' || meta.type === 'integer') {
        return `<label class="block space-y-1">
          <div class="flex justify-between"><span>${meta.label || meta.name}</span><span class="text-white/40 text-xs" id="val-${meta.name}">${val}</span></div>
          <input type="range" data-param="${meta.name}" min="${meta.min}" max="${meta.max}" step="${meta.step}" value="${val}" class="w-full accent-primary-400" />
        </label>`;
      } else if (meta.type === 'select') {
        const opts = (meta.options||[]).map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
        return `<label class="block space-y-1">
          <div class="flex justify-between"><span>${meta.label || meta.name}</span></div>
          <select data-param="${meta.name}" class="w-full bg-white/10 border border-white/10 rounded px-2 py-1 text-sm">${opts}</select>
        </label>`;
      } else if (meta.type === 'boolean') {
        return `<label class="flex items-center gap-2">
          <input type="checkbox" data-param="${meta.name}" ${val? 'checked':''} class="accent-primary-400" />
          <span>${meta.label || meta.name}</span>
        </label>`;
      } else if (meta.type === 'string') {
        return `<label class="block space-y-1">
          <div class="flex justify-between"><span>${meta.label || meta.name}</span></div>
          <input type="text" data-param="${meta.name}" value="${val || ''}" placeholder="${meta.placeholder || ''}" class="w-full bg-white/10 border border-white/10 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40" />
          ${meta.hint ? `<p class='text-[10px] text-white/40'>${meta.hint}</p>`: ''}
        </label>`;
      }
      return '';
    }).join('<div class="h-2"></div>');
    configBody.innerHTML = `<form id="params-form" class="space-y-4">${fields}</form>`;
    const form = document.getElementById('params-form');
    form.querySelectorAll('[data-param]').forEach(el => {
      el.addEventListener('input', () => {
        const name = el.getAttribute('data-param');
        let value;
        if (el.type === 'checkbox') value = el.checked;
        else if (el.tagName === 'SELECT') value = el.value;
        else if (el.type === 'range') value = parseFloat(el.value);
        currentParams[name] = value;
        const valLabel = document.getElementById(`val-${name}`);
        if (valLabel) valLabel.textContent = value;
      });
    });
  }
  // remove old listener already replaced

  async function loadHistory() {
    try {
      // Avoid stale cached responses (some browsers may cache GET /api/chats)
      const res = await fetch('/api/chats', { cache: 'no-store' });
      const data = await res.json();
      const chats = data.chats || [];
      historyEl.innerHTML = '';
      const newBtn = document.createElement('button');
      newBtn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition';
      newBtn.textContent = 'New chatâ€¦';
      newBtn.addEventListener('click', () => startNewChat());
      historyEl.appendChild(newBtn);
      if (!chats.length) {
        const empty = document.createElement('div');
        empty.className = 'text-white/60 text-sm';
        empty.textContent = 'No previous chats yet.';
        historyEl.appendChild(empty);
      }
      for (const c of chats) {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition';
        btn.innerHTML = `<div class="flex items-center justify-between"><span class="truncate">${escapeHtml(c.title || 'Untitled')}</span><span class="text-xs text-white/40 ms-2">${escapeHtml(c.provider || '')}</span></div>`;
        btn.addEventListener('click', () => openChat(c.id));
        historyEl.appendChild(btn);
      }
    } catch (e) {
      // ignore
    }
  }

  async function openChat(id) {
    try {
      const res = await fetch(`/api/chats/${id}`);
      if (!res.ok) return;
      const data = await res.json();
      const chat = data.chat;
      const msgs = data.messages || [];
      currentChatId = chat.id;
      chatTitleEl.value = chat.title || '';
      providerEl.value = chat.provider || providerEl.value;
      populateModels();
      if (chat.model) modelEl.value = chat.model;
      messagesEl.innerHTML = '';
      history = [];
      for (const m of msgs) {
        appendMessage(m.role, m.content, m.provider, m.model);
        history.push({ role: m.role, content: m.content });
      }
    } catch (e) {
      // ignore
    }
  }

  function startNewChat() {
    currentChatId = null;
    chatTitleEl.value = '';
    messagesEl.innerHTML = '';
    history = [];
    appendMessage('assistant', 'New chat started. How can I help?');
  }

  function appendMessage(role, text, provider = null, model = null, isError = false) {
    const isUser = role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
    const badge = provider && model ? `<div class="text-[10px] text-white/50 mb-1">${escapeHtml(provider)}/${escapeHtml(model)}</div>` : '';
    wrapper.innerHTML = `
      ${isUser ? '' : '<div class="shrink-0 w-8 h-8 rounded-full bg-primary-600/80 grid place-items-center">ðŸ§ </div>'}
      <div class="max-w-3xl">${badge}<div class="rounded-xl border ${isError ? 'border-red-400/60 bg-red-500/10' : 'border-white/10 ' + (isUser ? 'bg-primary-600/20' : 'bg-white/5')} p-3">${escapeHtml(text)}</div></div>
    `;
    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  composerEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('[FRONTEND] Form submitted, isSubmitting:', isSubmitting);
    
    // Prevent duplicate submissions
    if (isSubmitting) {
      console.log('[FRONTEND] Already submitting, ignoring duplicate');
      return;
    }
    
    const message = inputEl.value.trim();
    if (!message) {
      console.log('[FRONTEND] Empty message, ignoring');
      return;
    }
    
    isSubmitting = true; // Set flag to prevent duplicates
    inputEl.value = '';
    const provider = providerEl.value;
    const model = modelEl.value;
    
    console.log('[FRONTEND] Sending message:', { message: message.substring(0, 50), provider, model, chat_id: currentChatId, project_id: currentProjectId });
    
    appendMessage('user', message, provider, model);
    // Note: Don't add to history yet - the backend will handle adding both user and assistant messages
    // We'll add the user message to local history after successful submission, and assistant after streaming completes

    const title = chatTitleEl.value.trim();
    
    // Create assistant message placeholder for streaming with unique IDs
    const messageId = Date.now(); // Use timestamp as unique ID
    console.log('[FRONTEND] Created message placeholder with ID:', messageId);
    
    const assistantWrapper = document.createElement('div');
    assistantWrapper.className = 'flex items-start gap-3';
    const badge = `<div class="text-[10px] text-white/50 mb-1">${escapeHtml(provider)}/${escapeHtml(model)}</div>`;
    assistantWrapper.innerHTML = `
      <div class="shrink-0 w-8 h-8 rounded-full bg-primary-600/80 grid place-items-center">ðŸ§ </div>
      <div class="max-w-3xl">${badge}<div class="rounded-xl border border-white/10 bg-white/5 p-3">
        <span id="loading-indicator-${messageId}" class="text-white/60">Thinking...</span>
        <span id="streaming-content-${messageId}" style="display: none;"></span>
        <span id="typing-indicator-${messageId}" style="display: none;">â–‹</span>
      </div></div>
    `;
    messagesEl.appendChild(assistantWrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    
    const loadingIndicator = document.getElementById(`loading-indicator-${messageId}`);
    const streamingContent = document.getElementById(`streaming-content-${messageId}`);
    const typingIndicator = document.getElementById(`typing-indicator-${messageId}`);
    let fullReply = '';
    
    try {
      console.log('[FRONTEND] Starting streaming request to /api/chat/stream');
      
      const response = await fetch('/api/chat/stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message, history, provider, model, chat_id: currentChatId, title, project_id: currentProjectId, params: currentParams })
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      console.log('[FRONTEND] Got streaming response, starting to read');
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let streamingStarted = false;
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));
              
              if (data.type === 'metadata') {
                console.log('[FRONTEND] Received metadata:', data);
                // Handle metadata (chat_id, title, etc.)
                if (data.chat_id) currentChatId = data.chat_id;
                if (data.title && !title) chatTitleEl.value = data.title;
                // Ensure sidebar history reflects newly created chat immediately
                // (previously only refreshed after full streaming completion)
                loadHistory();
              } else if (data.type === 'token') {
                console.log('[FRONTEND] Received token:', JSON.stringify(data.token));
                // Start streaming: hide loading, show streaming content and typing indicator
                if (!streamingStarted) {
                  streamingStarted = true;
                  console.log('[FRONTEND] Starting token streaming');
                  if (loadingIndicator) loadingIndicator.style.display = 'none';
                  if (streamingContent) streamingContent.style.display = 'inline';
                  if (typingIndicator) typingIndicator.style.display = 'inline';
                }
                
                // Append token to the streaming content
                fullReply += data.token;
                console.log('[FRONTEND] Full reply so far:', JSON.stringify(fullReply));
                if (streamingContent) {
                  streamingContent.textContent = fullReply;
                  messagesEl.scrollTop = messagesEl.scrollHeight;
                }
              } else if (data.type === 'error') {
                console.log('[FRONTEND] Received error:', data.error);
                // Handle errors
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (typingIndicator) typingIndicator.style.display = 'none';
                if (streamingContent) {
                  streamingContent.style.display = 'inline';
                  streamingContent.textContent = data.error || 'Provider error';
                  streamingContent.parentNode.className = 'rounded-xl border border-red-400/60 bg-red-500/10 p-3';
                }
                
                if (data.missing_key_for) {
                  // Open settings and focus the appropriate input
                  const settingsBtn = document.getElementById('settings-btn');
                  const openModal = () => settingsBtn?.click();
                  openModal();
                  setTimeout(() => {
                    try {
                      const el = data.missing_key_for === 'openai' ? document.getElementById('key-openai') : document.getElementById('key-gemini');
                      el?.focus();
                    } catch (_) {}
                  }, 50);
                }
                isSubmitting = false; // Reset flag on error
                return;
              } else if (data.type === 'warning') {
                console.log('[FRONTEND] Received warning:', data.warning);
                // Handle warnings
                showToast(data.warning);
              } else if (data.type === 'done') {
                console.log('[FRONTEND] Streaming complete, full reply length:', fullReply.length);
                // Streaming complete
                if (typingIndicator) typingIndicator.style.display = 'none';
                // Now add both user and assistant messages to history
                history.push({ role: 'user', content: message });
                history.push({ role: 'assistant', content: fullReply });
                loadHistory();
                isSubmitting = false; // Reset flag on completion
                return;
              }
            } catch (parseError) {
              console.error('[FRONTEND] Error parsing streaming data:', parseError);
            }
          }
        }
      }
      
    } catch (err) {
      console.error('[FRONTEND] Streaming error:', err);
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      if (typingIndicator) typingIndicator.style.display = 'none';
      if (streamingContent) {
        streamingContent.style.display = 'inline';
        streamingContent.textContent = 'Error contacting server.';
        streamingContent.parentNode.className = 'rounded-xl border border-red-400/60 bg-red-500/10 p-3';
      }
      showToast('Provider call failed or API key missing. Open settings to configure.');
      isSubmitting = false; // Reset flag on error
    }
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      composerEl.requestSubmit();
    }
  });

  newChatEl.addEventListener('click', () => {
    startNewChat();
  });

  deleteChatEl.addEventListener('click', async () => {
    // If no persisted chat yet, just soft clear the UI
    if (!currentChatId) {
      startNewChat();
      return;
    }
    const deletingId = currentChatId;
    try {
      const res = await fetch(`/api/chats/${deletingId}`, { method: 'DELETE' });
      if (res.ok) {
        // Reset currentChatId immediately to avoid race conditions with stale value
        currentChatId = null;
        // Refetch remaining chats with no-store to prevent caching
        try {
          const listRes = await fetch('/api/chats', { cache: 'no-store' });
          if (listRes.ok) {
            const payload = await listRes.json();
            const chats = payload.chats || [];
            if (chats.length > 0) {
              await openChat(chats[0].id);
            } else {
              startNewChat();
            }
          } else {
            startNewChat();
          }
        } catch (_) {
          startNewChat();
        }
        loadHistory();
        showToast('Chat deleted');
      } else {
        showToast('Delete failed');
      }
    } catch (e) {
      showToast('Delete error');
    }
  });

  chatTitleEl.addEventListener('change', async () => {
    const title = chatTitleEl.value.trim();
    if (!currentChatId || !title) return;
    await fetch(`/api/chats/${currentChatId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title })
    });
    loadHistory();
  });

  clearHistoryEl?.addEventListener('click', async () => {
    // Soft clear: start new chat view, leave DB intact
    startNewChat();
  });

  // Project management functions
  async function loadProjects() {
    try {
      const res = await fetch('/api/projects', { cache: 'no-store' });
      const data = await res.json();
      projects = data.projects || [];
      populateProjectSelector();
      populateProjectsList();
    } catch (err) {
      console.error('Failed to load projects:', err);
    }
  }

  function populateProjectSelector() {
    const options = ['<option value="">No project</option>'];
    for (const project of projects) {
      const selected = currentProjectId === project.id ? ' selected' : '';
      options.push(`<option value="${project.id}"${selected}>${project.name}</option>`);
    }
    projectEl.innerHTML = options.join('');
  }

  function populateProjectsList() {
    projectsListEl.innerHTML = '';
    projectListPanel.innerHTML = '';
    
    // Add "New project" button to sidebar
    const newBtn = document.createElement('button');
    newBtn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition';
    newBtn.textContent = 'New projectâ€¦';
    newBtn.addEventListener('click', () => openProjectModal());
    projectsListEl.appendChild(newBtn);
    
    if (!projects.length) {
      const empty = document.createElement('div');
      empty.className = 'text-white/60 text-sm';
      empty.textContent = 'No projects yet.';
      projectsListEl.appendChild(empty);
      return;
    }
    
    // Add projects to sidebar
    for (const project of projects) {
      const btn = document.createElement('button');
      btn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition text-sm truncate';
      btn.textContent = project.name;
      btn.addEventListener('click', () => {
        currentProjectId = project.id;
        populateProjectSelector();
        loadHistory(); // Refresh to show chats for this project
      });
      projectsListEl.appendChild(btn);
      
      // Add to modal project list
      const modalBtn = document.createElement('button');
      modalBtn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition text-sm truncate';
      modalBtn.textContent = project.name;
      modalBtn.addEventListener('click', () => selectProjectInModal(project.id));
      projectListPanel.appendChild(modalBtn);
    }
  }

  function openProjectModal() {
    selectedProjectIdInModal = null;
    projectForm.classList.add('hidden');
    noProjectSelected.classList.remove('hidden');
    projectOverlay.classList.remove('pointer-events-none');
    requestAnimationFrame(() => {
      projectOverlay.classList.add('opacity-100');
      projectModal.classList.add('opacity-100', 'scale-100');
    });
    loadProjects(); // Refresh project list
  }

  function closeProjectModal() {
    projectOverlay.classList.add('pointer-events-none');
    projectOverlay.classList.remove('opacity-100');
    projectModal.classList.remove('opacity-100', 'scale-100');
  }

  async function selectProjectInModal(projectId) {
    selectedProjectIdInModal = projectId;
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    projectNameEl.value = project.name || '';
    projectDescriptionEl.value = project.description || '';
    projectSystemPromptEl.value = project.system_prompt || '';
    
    projectForm.classList.remove('hidden');
    noProjectSelected.classList.add('hidden');
    
    // Load project files
    try {
      const res = await fetch(`/api/projects/${projectId}`, { cache: 'no-store' });
      const data = await res.json();
      populateProjectFiles(data.files || []);
    } catch (err) {
      console.error('Failed to load project details:', err);
    }
  }

  function populateProjectFiles(files) {
    projectFilesEl.innerHTML = '';
    for (const file of files) {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'flex items-center justify-between p-2 rounded-lg bg-white/5 border border-white/10';
      fileDiv.innerHTML = `
        <span class="text-sm truncate">${file.filename}</span>
        <div class="flex gap-1">
          <button class="px-2 py-1 text-xs rounded bg-white/10 hover:bg-white/20 transition edit-file-btn" data-file-id="${file.id}">Edit</button>
          <button class="px-2 py-1 text-xs rounded bg-red-600/20 hover:bg-red-600/30 text-red-200 transition delete-file-btn" data-file-id="${file.id}">Delete</button>
        </div>
      `;
      projectFilesEl.appendChild(fileDiv);
    }
    
    // Add event listeners for file buttons
    projectFilesEl.querySelectorAll('.edit-file-btn').forEach(btn => {
      btn.addEventListener('click', () => editFile(parseInt(btn.dataset.fileId)));
    });
    projectFilesEl.querySelectorAll('.delete-file-btn').forEach(btn => {
      btn.addEventListener('click', () => deleteFile(parseInt(btn.dataset.fileId)));
    });
  }

  async function editFile(fileId) {
    const filename = prompt('Enter filename:');
    if (!filename) return;
    
    const content = prompt('Enter file content:');
    if (content === null) return;
    
    try {
      await fetch(`/api/projects/${selectedProjectIdInModal}/files/${fileId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, content })
      });
      selectProjectInModal(selectedProjectIdInModal); // Refresh
    } catch (err) {
      showToast('Failed to update file');
    }
  }

  async function deleteFile(fileId) {
    if (!confirm('Delete this file?')) return;
    
    try {
      await fetch(`/api/projects/${selectedProjectIdInModal}/files/${fileId}`, {
        method: 'DELETE'
      });
      selectProjectInModal(selectedProjectIdInModal); // Refresh
    } catch (err) {
      showToast('Failed to delete file');
    }
  }

  // Tab switching
  tabChatsEl?.addEventListener('click', () => {
    tabChatsEl.classList.add('bg-white/10', 'text-white');
    tabChatsEl.classList.remove('text-white/70', 'hover:text-white', 'hover:bg-white/5');
    tabProjectsEl.classList.remove('bg-white/10', 'text-white');
    tabProjectsEl.classList.add('text-white/70', 'hover:text-white', 'hover:bg-white/5');
    chatsTabEl.classList.remove('hidden');
    chatsTabEl.classList.add('flex');
    projectsTabEl.classList.add('hidden');
    projectsTabEl.classList.remove('flex');
  });

  tabProjectsEl?.addEventListener('click', () => {
    tabProjectsEl.classList.add('bg-white/10', 'text-white');
    tabProjectsEl.classList.remove('text-white/70', 'hover:text-white', 'hover:bg-white/5');
    tabChatsEl.classList.remove('bg-white/10', 'text-white');
    tabChatsEl.classList.add('text-white/70', 'hover:text-white', 'hover:bg-white/5');
    projectsTabEl.classList.remove('hidden');
    projectsTabEl.classList.add('flex');
    chatsTabEl.classList.add('hidden');
    chatsTabEl.classList.remove('flex');
  });

  // Project modal event listeners
  newProjectSidebarEl?.addEventListener('click', openProjectModal);
  newProjectBtn?.addEventListener('click', () => {
    selectedProjectIdInModal = null;
    projectNameEl.value = '';
    projectDescriptionEl.value = '';
    projectSystemPromptEl.value = '';
    projectForm.classList.remove('hidden');
    noProjectSelected.classList.add('hidden');
    projectFilesEl.innerHTML = '';
  });

  closeProjectBtn?.addEventListener('click', closeProjectModal);
  closeProjectFooterBtn?.addEventListener('click', closeProjectModal);

  saveProjectBtn?.addEventListener('click', async () => {
    const name = projectNameEl.value.trim();
    if (!name) {
      showToast('Project name is required');
      return;
    }
    
    const data = {
      name,
      description: projectDescriptionEl.value.trim() || null,
      system_prompt: projectSystemPromptEl.value.trim() || null
    };
    
    try {
      let res;
      if (selectedProjectIdInModal) {
        res = await fetch(`/api/projects/${selectedProjectIdInModal}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else {
        res = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.project_id) {
          selectedProjectIdInModal = result.project_id;
        }
      }
      
      if (res.ok) {
        showToast('Project saved');
        loadProjects();
      } else {
        showToast('Failed to save project');
      }
    } catch (err) {
      showToast('Failed to save project');
    }
  });

  deleteProjectBtn?.addEventListener('click', async () => {
    if (!selectedProjectIdInModal) return;
    if (!confirm('Delete this project? Associated chats will be preserved but unlinked.')) return;
    
    try {
      const res = await fetch(`/api/projects/${selectedProjectIdInModal}`, {
        method: 'DELETE'
      });
      
      if (res.ok) {
        showToast('Project deleted');
        loadProjects();
        closeProjectModal();
      } else {
        showToast('Failed to delete project');
      }
    } catch (err) {
      showToast('Failed to delete project');
    }
  });

  newFileBtnEl?.addEventListener('click', async () => {
    if (!selectedProjectIdInModal) return;
    
    const filename = prompt('Enter filename:');
    if (!filename) return;
    
    const content = prompt('Enter file content:') || '';
    
    try {
      const res = await fetch(`/api/projects/${selectedProjectIdInModal}/files`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, content })
      });
      
      if (res.ok) {
        selectProjectInModal(selectedProjectIdInModal); // Refresh
      } else {
        showToast('Failed to create file');
      }
    } catch (err) {
      showToast('Failed to create file');
    }
  });

  // Update chat submission to include project_id
  const originalFormSubmit = composerEl.addEventListener;
  
  // Project selector change handler
  projectEl?.addEventListener('change', () => {
    currentProjectId = projectEl.value ? parseInt(projectEl.value) : null;
  });

  loadProjects();
  loadProviders();
  loadHistory();
</script>
{% endblock %}

{% block extra %}{% endblock %}
