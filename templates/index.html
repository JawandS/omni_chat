{% extends "base.html" %}

{% block header %}
Omni Chat
{% endblock %}

{% block content %}
<div class="grid grid-cols-12 gap-4 md:gap-6 h-full min-h-0">
  <!-- Sidebar: conversation history (placeholder) -->
  <aside class="hidden md:block col-span-3 min-h-0">
    <div class="h-full min-h-0 rounded-xl border border-white/10 bg-white/5">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <span class="font-medium">History</span>
        <button id="clear-history" class="text-sm text-white/70 hover:text-white">Clear</button>
      </div>
      <div id="history" class="p-3 space-y-2 overflow-auto h-[calc(100%-3.25rem)]"></div>
    </div>
  </aside>

  <!-- Main chat area -->
  <section class="col-span-12 md:col-span-9 flex flex-col min-h-0">
    <!-- Top bar: provider + model selectors + centered title -->
    <div class="rounded-xl border border-white/10 bg-white/5 p-3 md:p-4 mb-3 md:mb-4">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2">
          <label for="provider" class="text-sm text-white/70">Provider</label>
          <div class="relative">
            <select id="provider" data-testid="provider-select" class="appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition">
              <option>Loadingâ€¦</option>
            </select>
            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/70">â–¾</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="model" class="text-sm text-white/70">Model</label>
          <div class="relative">
            <select id="model" data-testid="model-select" class="appearance-none text-white bg-white/10 border border-white/10 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 hover:bg-white/15 transition min-w-48">
              <option>Select provider first</option>
            </select>
            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/70">â–¾</span>
          </div>
        </div>
        <!-- Centered title -->
        <div class="flex-1 flex justify-center">
          <input id="chat-title" type="text" placeholder="Untitled chat" class="w-56 md:w-80 text-center rounded-lg bg-white/10 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400/40 placeholder-white/40" />
        </div>
        <div class="ms-auto flex items-center gap-2">
          <button id="new-chat" class="inline-flex items-center rounded-lg bg-primary-600 hover:bg-primary-500 focus:ring-4 focus:ring-primary-400/40 px-4 py-2 text-sm font-medium transition">New Chat</button>
          <button id="delete-chat" class="inline-flex items-center rounded-lg bg-red-600 hover:bg-red-500 focus:ring-4 focus:ring-red-400/40 px-3 py-2 text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" title="Delete current chat">Delete</button>
        </div>
      </div>
    </div>

  <!-- Warning toast -->
  <div id="toast" class="hidden mb-2 rounded-lg bg-yellow-500/20 border border-yellow-400/30 text-yellow-200 text-sm px-3 py-2"></div>
  <!-- Messages -->
  <div id="messages" class="flex-1 min-h-0 overflow-y-auto space-y-4 pr-1">
      <div class="flex items-start gap-3">
        <div class="shrink-0 w-8 h-8 rounded-full bg-primary-600/80 grid place-items-center">ðŸ§ </div>
        <div class="rounded-xl border border-white/10 bg-white/5 p-3 max-w-3xl">
          <p class="text-white/90">Hi! Ask me anything. Iâ€™ll respond here.</p>
        </div>
      </div>
    </div>

    <!-- Composer -->
  <form id="composer" class="mt-3 md:mt-4">
      <div class="relative">
    <textarea id="input" rows="1" placeholder="Messageâ€¦" class="w-full resize-none rounded-2xl border border-white/10 bg-white/5 focus:bg-white/10 transition p-4 pr-24 outline-none focus:ring-2 focus:ring-primary-400/40"></textarea>
    <button id="send" type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center rounded-xl bg-primary-600 hover:bg-primary-500 focus:ring-4 focus:ring-primary-400/40 px-3 py-2 text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
      </div>
      <p class="mt-2 text-xs text-white/50">Press Enter to send â€¢ Shift+Enter for newline</p>
    </form>
  </section>
</div>

<script>
  const providerEl = document.getElementById('provider');
  const modelEl = document.getElementById('model');
  const messagesEl = document.getElementById('messages');
  const composerEl = document.getElementById('composer');
  const inputEl = document.getElementById('input');
  const newChatEl = document.getElementById('new-chat');
  const historyEl = document.getElementById('history');
  const clearHistoryEl = document.getElementById('clear-history');
  const chatTitleEl = document.getElementById('chat-title');
  const deleteChatEl = document.getElementById('delete-chat');
  const toastEl = document.getElementById('toast');
  function showToast(msg) {
    if (!msg) return;
    toastEl.textContent = msg;
    toastEl.classList.remove('hidden');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.add('hidden'), 4000);
  }

  let providers = [];
  let history = [];
  let currentChatId = null;

  async function loadProviders() {
    try {
      const res = await fetch('/static/providers.json', { cache: 'no-store' });
      const data = await res.json();
      providers = data.providers || [];
      providerEl.innerHTML = providers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      if (providers.length) {
        providerEl.value = providers[0].id;
        populateModels();
      }
    } catch (e) {
      // Fallback
      providers = [{ id: 'openai', name: 'OpenAI', models: ['gpt-4o-mini'] }];
      providerEl.innerHTML = `<option value="openai">OpenAI</option>`;
      populateModels();
    }
  }

  function populateModels() {
    const p = providers.find(x => x.id === providerEl.value);
    const models = p ? p.models : [];
    modelEl.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('') || '<option>No models</option>';
  }

  providerEl.addEventListener('change', populateModels);

  async function loadHistory() {
    try {
      const res = await fetch('/api/chats');
      const data = await res.json();
      const chats = data.chats || [];
      historyEl.innerHTML = '';
      const newBtn = document.createElement('button');
      newBtn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition';
      newBtn.textContent = 'New chatâ€¦';
      newBtn.addEventListener('click', () => startNewChat());
      historyEl.appendChild(newBtn);
      if (!chats.length) {
        const empty = document.createElement('div');
        empty.className = 'text-white/60 text-sm';
        empty.textContent = 'No previous chats yet.';
        historyEl.appendChild(empty);
      }
      for (const c of chats) {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-3 py-2 rounded-lg bg-white/0 hover:bg-white/10 transition';
        btn.innerHTML = `<div class="flex items-center justify-between"><span class="truncate">${escapeHtml(c.title || 'Untitled')}</span><span class="text-xs text-white/40 ms-2">${escapeHtml(c.provider || '')}</span></div>`;
        btn.addEventListener('click', () => openChat(c.id));
        historyEl.appendChild(btn);
      }
    } catch (e) {
      // ignore
    }
  }

  async function openChat(id) {
    try {
      const res = await fetch(`/api/chats/${id}`);
      if (!res.ok) return;
      const data = await res.json();
      const chat = data.chat;
      const msgs = data.messages || [];
      currentChatId = chat.id;
      chatTitleEl.value = chat.title || '';
      providerEl.value = chat.provider || providerEl.value;
      populateModels();
      if (chat.model) modelEl.value = chat.model;
      messagesEl.innerHTML = '';
      history = [];
      for (const m of msgs) {
        appendMessage(m.role, m.content, m.provider, m.model);
        history.push({ role: m.role, content: m.content });
      }
    } catch (e) {
      // ignore
    }
  }

  function startNewChat() {
    currentChatId = null;
    chatTitleEl.value = '';
    messagesEl.innerHTML = '';
    history = [];
    appendMessage('assistant', 'New chat started. How can I help?');
  }

  function appendMessage(role, text, provider = null, model = null, isError = false) {
    const isUser = role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
    const badge = provider && model ? `<div class="text-[10px] text-white/50 mb-1">${escapeHtml(provider)}/${escapeHtml(model)}</div>` : '';
    wrapper.innerHTML = `
      ${isUser ? '' : '<div class="shrink-0 w-8 h-8 rounded-full bg-primary-600/80 grid place-items-center">ðŸ§ </div>'}
      <div class="max-w-3xl">${badge}<div class="rounded-xl border ${isError ? 'border-red-400/60 bg-red-500/10' : 'border-white/10 ' + (isUser ? 'bg-primary-600/20' : 'bg-white/5')} p-3">${escapeHtml(text)}</div></div>
    `;
    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  composerEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = inputEl.value.trim();
    if (!message) return;
    inputEl.value = '';
  const provider = providerEl.value;
  const model = modelEl.value;
  appendMessage('user', message, provider, model);
    history.push({ role: 'user', content: message });

    const title = chatTitleEl.value.trim();
    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, history, provider, model, chat_id: currentChatId, title })
      });
      const data = await res.json();
      const reply = data.reply || 'No reply received.';
      const isErr = !!data.error;
      appendMessage('assistant', isErr ? (data.error || 'Provider error') : reply, provider, model, isErr);
      if (data.missing_key_for) {
        // Open settings and focus the appropriate input
        const settingsBtn = document.getElementById('settings-btn');
        const openModal = () => settingsBtn?.click();
        openModal();
        setTimeout(() => {
          try {
            const el = data.missing_key_for === 'openai' ? document.getElementById('key-openai') : document.getElementById('key-gemini');
            el?.focus();
          } catch (_) {}
        }, 50);
      }
  if (data.warning) showToast(data.warning);
      history.push({ role: 'assistant', content: reply });
      if (data.chat_id) currentChatId = data.chat_id;
      if (data.title && !title) chatTitleEl.value = data.title;
      loadHistory();
    } catch (err) {
      appendMessage('assistant', 'Error contacting server.', null, null, true);
      showToast('Provider call failed or API key missing. Open settings to configure.');
    }
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      composerEl.requestSubmit();
    }
  });

  newChatEl.addEventListener('click', () => {
    startNewChat();
  });

  deleteChatEl.addEventListener('click', async () => {
    if (!currentChatId) return;
    try {
      const res = await fetch(`/api/chats/${currentChatId}`, { method: 'DELETE' });
      if (res.ok) {
        // After deletion, load remaining chats and switch to the next one if available
        try {
          const listRes = await fetch('/api/chats');
          if (listRes.ok) {
            const payload = await listRes.json();
            const chats = payload.chats || [];
            if (chats.length > 0) {
              await openChat(chats[0].id);
            } else {
              startNewChat();
            }
          } else {
            startNewChat();
          }
        } catch (_) {
          startNewChat();
        }
        loadHistory();
      }
    } catch (_) {}
  });

  chatTitleEl.addEventListener('change', async () => {
    const title = chatTitleEl.value.trim();
    if (!currentChatId || !title) return;
    await fetch(`/api/chats/${currentChatId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title })
    });
    loadHistory();
  });

  clearHistoryEl?.addEventListener('click', async () => {
    // Soft clear: start new chat view, leave DB intact
    startNewChat();
  });

  loadProviders();
  loadHistory();
</script>
{% endblock %}

{% block extra %}{% endblock %}
